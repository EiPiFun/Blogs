# Reference: https://bbs.archlinux.org/viewtopic.php?id=277713

# Kernel parameters

```
blacklist nouveau
options nvidia-drm modeset=1 fbdev=1
options nvidia NVreg_TemporaryFilePath=/var/tmp/
options nvidia NVreg_PreserveVideoMemoryAllocations=1
```

# Update initramfs if needed

# Enable nvidia service

sudo systemctl enable nvidia-hibernate nvidia-resume nvidia-suspend

# gnome-shell suspend and resume

sudo vi /etc/systemd/system/gnome-shell-suspend.service

```
[Unit]
Description=gnome-shell suspend
Before=systemd-suspend.service
Before=systemd-hibernate.service
Before=nvidia-suspend.service
Before=nvidia-hibernate.service

[Service]
Type=oneshot
ExecStart=/usr/bin/pkill --signal STOP gnome-shell

[Install]
WantedBy=systemd-suspend.service
WantedBy=systemd-hibernate.service
```

sudo vi /etc/systemd/system/gnome-shell-resume.service

```
[Unit]
Description=gnome-shell resume
After=systemd-suspend.service
After=systemd-hibernate.service
After=nvidia-resume.service

[Service]
Type=oneshot
ExecStart=/usr/bin/pkill --signal CONT gnome-shell

[Install] 
WantedBy=systemd-suspend.service 
WantedBy=systemd-hibernate.service
```

sudo systemctl daemon-reload
sudo systemctl enable gnome-shell-suspend
sudo systemctl enable gnome-shell-resume

# cuda usage including nvdec and nvidia-vaapi-driver may cause suspend problems
# prefer vulkan or vdpau for hardware video decoding

sudo vi /etc/systemd/system/before_suspend.service

```
[Unit]
Description=before suspend
Before=systemd-suspend.service
Before=systemd-hibernate.service
Before=nvidia-suspend.service
Before=nvidia-hibernate.service

[Service]
Type=oneshot
ExecStart=/usr/bin/sh -c 'for i in firefox-bin mpv;do if [ "$(/usr/bin/pgrep $i)" ];then /usr/bin/pkill $i;fi;done:sleep 3'

[Install]
WantedBy=systemd-suspend.service
WantedBy=systemd-hibernate.service
```

sudo systemctl daemon-reload
sudo systemctl enable before_suspend

